<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Photo Manager (IndexedDB)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üñºÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8fafc;
            min-height: 100vh;
        }
        .dropzone {
            position: relative;
            background-image: repeating-linear-gradient(45deg, #f1f5f9 0px, #f1f5f9 10px, #f8fafc 10px, #f8fafc 20px);
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        .top-right-loader {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-30px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #e2e8f0;
        }
        .top-right-loader.active {
            transform: translateY(0);
            opacity: 1;
        }
        .photo-card {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            background: white;
            transform-origin: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            cursor: move;
        }
        .photo-card .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
        }
        .photo-card:hover .delete-btn {
            opacity: 1;
        }
        .photo-card img {
            height: 200px;
            object-fit: cover;
            background: linear-gradient(45deg, #f9fafb, #f1f5f9);
            transition: transform 0.3s ease-in-out;
            will-change: transform;
        }
        .photo-card:hover img {
            transform: scale(1.03);
        }
        .photo-card.dragging {
            opacity: 0.95;
            transform: scale(1);
            z-index: 999;
            position: relative;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            user-select: none;
        }
        .photo-card.drag-over {
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .photo-card.dragging img {
            transform: scale(1);
        }
        .empty-gallery {
            grid-column: 1 / -1;
            padding: 50px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            border: 1px dashed #cbd5e1;
            text-align: center;
        }
        .empty-gallery i {
            font-size: 52px;
            color: #cbd5e1;
            margin-bottom: 16px;
        }
        .empty-gallery h3 {
            font-size: 22px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .empty-gallery p {
            color: #94a3b8;
            max-width: 380px;
            margin: 0 auto;
        }
        .progress-fill {
            background: linear-gradient(90deg, #6366f1, #3b82f6, #60a5fa);
        }
        @media (max-width: 1024px) {
            .upload-and-db-flex {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            .db-stats-panel {
                margin-top: 16px;
                width: 100%;
            }
        }
        @media (max-width: 768px) {
            .top-right-loader {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            .db-stats-panel {
                width: 100%;
                margin-top: 8px;
                margin-left: 0;
            }
        }
        .drag-image {
            box-sizing: border-box;
            border-radius: 12px;
            background: white;
        }
        .db-stats-panel {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            padding: 20px;
            min-width: 240px;
            max-width: 350px;
            margin-left: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            height: 100%;
            box-sizing: border-box;
            justify-content: center;
        }
        .db-stats-panel .title {
            font-weight: bold;
            color: #334155;
            font-size: 15px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .db-stats-bar {
            height: 10px;
            background: #e0e7ef;
            border-radius: 8px;
            margin: 8px 0;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        .db-stats-bar-used {
            background: linear-gradient(90deg, #6366f1, #3b82f6, #60a5fa);
            height: 100%;
            border-radius: 8px 0 0 8px;
            transition: width 0.4s;
        }
        .db-stats-panel .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 3px 0;
        }
        .upload-area-panel {
            min-width: 0;
            flex: 1 1 0%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- –õ–æ–∞–¥–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div id="topLoader" class="top-right-loader">
        <div class="loader-header flex justify-between items-center mb-5 pb-4 border-b border-slate-100">
            <div class="loader-title text-xl font-bold text-blue-700 flex items-center gap-2">
                <i class="fas fa-cloud-arrow-up animate-pulse"></i>
                Uploading Photos
            </div>
            <button class="close-btn w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center">
                &times;
            </button>
        </div>
        <div class="overall-progress text-center mb-5">
            <span id="progressText" class="font-medium text-indigo-800">Processing files...</span>
        </div>
        <div class="file-list overflow-y-auto max-h-[300px] space-y-3" id="fileList"></div>
        <div class="cancel-btn mt-6">
            <button id="cancelAllBtn" class="w-full py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors duration-200">
                Cancel Upload
            </button>
        </div>
    </div>
    <main class="container mx-auto py-6 px-4 max-w-6xl">
        <!-- FLEX CONTAINER: upload + db info -->
        <div class="upload-and-db-flex flex flex-row items-center justify-between mb-8 gap-4" style="width:100%;">
            <div class="upload-area-panel">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                    <h1 class="text-3xl lg:text-4xl font-black text-slate-800 flex items-center gap-3">
                        <i class="fas fa-images text-indigo-600"></i>
                        Photo Manager
                    </h1>
                    <div class="flex gap-3">
                        <button id="clearAllBtn" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                            <i class="fas fa-trash-can mr-2"></i> Clear All
                        </button>
                        <a href="gallery.html" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium flex items-center gap-2 transition-colors">
                            <i class="fas fa-play"></i> Start Slideshow
                        </a>
                    </div>
                </div>
                <!-- –û–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="bg-white rounded-2xl shadow-sm mb-0 dropzone overflow-hidden" id="uploadArea">
                    <div class="py-12 px-4 text-center" id="uploadPrompt">
                        <div class="mx-auto w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center mb-6">
                            <i class="fas fa-cloud-arrow-up text-5xl text-indigo-500"></i>
                        </div>
                        <div class="max-w-md mx-auto">
                            <p class="text-xl md:text-2xl text-slate-700 mb-2 font-semibold">Upload your images</p>
                            <p class="text-md text-slate-500 mb-6">Drag & drop photos here or browse files</p>
                        </div>
                        <input type="file" id="fileInput" class="hidden" accept="image/jpeg, image/png, image/webp" multiple>
                        <button id="selectFilesBtn" class="py-3 px-6 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded-full font-medium transition-all">
                            Select Photos
                        </button>
                        <p class="text-sm text-slate-400 mt-6">
                            Supported: JPG, PNG, WebP (Max size: 5MB)
                        </p>
                    </div>
                </div>
            </div>
            <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ IndexedDB -->
            <div class="db-stats-panel mt-6" id="dbStatsPanel">
                <div class="title"><i class="fas fa-database"></i> IndexedDB storage</div>
                <div class="db-stats-bar">
                    <div class="db-stats-bar-used" id="dbStatsBarUsed" style="width:0%"></div>
                </div>
                <div class="stat-row">
                    <span>Used:</span>
                    <span id="dbStatsUsed">0 KB</span>
                </div>
                <div class="stat-row">
                    <span>Total:</span>
                    <span id="dbStatsTotal">~50,000 KB</span>
                </div>
                <div class="stat-row">
                    <span>Free:</span>
                    <span id="dbStatsFree">~50,000 KB</span>
                </div>
                <div class="stat-row">
                    <span>Images:</span>
                    <span id="dbStatsCount">0</span>
                </div>
                <div class="text-xs text-slate-400 mt-2">* Actual limits –∑–∞–≤–∏—Å—è—Ç –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞</div>
            </div>
        </div>
        <!-- –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden pb-4">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-layer-group text-indigo-600"></i>
                    Gallery
                </h2>
                <div class="flex items-center gap-3">
                    <span id="photoCounter" class="text-slate-500">
                        0 photos
                    </span>
                    <div class="relative">
                        <button id="settingsBtn" class="p-2 rounded-lg hover:bg-slate-100">
                            <i class="fas fa-gear text-slate-500"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4" id="photosGrid">
                </div>
                <div id="emptyGallery" class="empty-gallery">
                    <div class="relative w-28 h-28 flex items-center justify-center">
                        <i class="fas fa-image absolute"></i>
                        <i class="fas fa-file-arrow-up absolute text-4xl text-indigo-200"></i>
                    </div>
                    <h3>Your gallery is empty</h3>
                    <p>Drop some images above or click "Select Photos" to start building your collection</p>
                </div>
            </div>
        </div>
    </main>
    <script>
        // --- IndexedDB helper class ---
        class GalleryDB {
            constructor() {
                this.dbName = 'photo_gallery_db';
                this.storeName = 'photos';
                this.db = null;
            }
            async open() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: false });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        reject('DB open error: ' + event.target.errorCode);
                    };
                });
            }
            async addPhoto(photo) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.add(photo);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async updatePhoto(photo) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.put(photo);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async deletePhoto(id) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async getAllPhotos() {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.getAll();
                    request.onsuccess = (e) => resolve(request.result || []);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async clearAll() {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async getUsedStorageSpace() {
                const photos = await this.getAllPhotos();
                let total = 0;
                for (const photo of photos) {
                    total += JSON.stringify(photo).length * 2 / 1024; // KB approx
                }
                return total;
            }
            async getPhotoCount() {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([this.storeName], 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.count();
                    request.onsuccess = (e) => resolve(request.result || 0);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        }
        const galleryDB = new GalleryDB();

        // --- State and DOM refs ---
        const state = {
            photos: [],
            currentUpload: {
                files: [],
                readers: {},
                fileItems: {}
            },
            draggedItem: null,
            originalStyles: {}
        };
        const dom = {
            uploadArea: document.getElementById('uploadArea'),
            uploadPrompt: document.getElementById('uploadPrompt'),
            fileInput: document.getElementById('fileInput'),
            selectFilesBtn: document.getElementById('selectFilesBtn'),
            photosGrid: document.getElementById('photosGrid'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            photoCounter: document.getElementById('photoCounter'),
            topLoader: document.getElementById('topLoader'),
            fileList: document.getElementById('fileList'),
            progressText: document.getElementById('progressText'),
            cancelAllBtn: document.getElementById('cancelAllBtn'),
            loaderClose: document.querySelector('.close-btn'),
            emptyGallery: document.getElementById('emptyGallery'),
            dbStatsPanel: document.getElementById('dbStatsPanel'),
            dbStatsUsed: document.getElementById('dbStatsUsed'),
            dbStatsTotal: document.getElementById('dbStatsTotal'),
            dbStatsFree: document.getElementById('dbStatsFree'),
            dbStatsCount: document.getElementById('dbStatsCount'),
            dbStatsBarUsed: document.getElementById('dbStatsBarUsed')
        };

        // –£—Å–ª–æ–≤–Ω—ã–π –ª–∏–º–∏—Ç (–¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏): 50 –ú–ë = 51200 –ö–ë
        const DB_TOTAL_LIMIT_KB = 51200;

        document.addEventListener('DOMContentLoaded', () => {
            loadPhotosFromDB().catch(e => {
                console.error('DB error:', e);
                showStorageAlert();
            });
            setupEventListeners();
            updateDbStatsPanel();
        });

        // --- CRUD with IndexedDB ---
        async function loadPhotosFromDB() {
            const photos = await galleryDB.getAllPhotos();
            photos.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
            state.photos = photos;
            renderPhotos();
            updateCounter();
            updateDbStatsPanel();
        }
        async function savePhotoToDB(photo) {
            const photoId = Date.now() + Math.floor(Math.random() * 1000);
            photo.id = photoId;
            await galleryDB.addPhoto(photo);
            updateDbStatsPanel();
            return photoId;
        }
        async function updatePhotoDB(photo) {
            await galleryDB.updatePhoto(photo);
        }
        async function deletePhotoFromDB(id) {
            await galleryDB.deletePhoto(id);
            updateDbStatsPanel();
        }
        async function clearAllPhotos() {
            if (state.photos.length > 0 && confirm('Delete all photos permanently?')) {
                await galleryDB.clearAll();
                state.photos = [];
                renderPhotos();
                updateCounter();
                updateDbStatsPanel();
            }
        }
        async function getUsedStorageSpace() {
            return Math.round(await galleryDB.getUsedStorageSpace());
        }
        async function showStorageAlert() {
            const usedSpace = await getUsedStorageSpace();
            alert(`‚ö†Ô∏è Storage is almost full!\nYou've used ${usedSpace}KB of available space.\nPlease delete some photos to free up space.`);
        }
        async function updateDbStatsPanel() {
            // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            const used = await galleryDB.getUsedStorageSpace();
            const count = await galleryDB.getPhotoCount();
            const total = DB_TOTAL_LIMIT_KB;
            const free = Math.max(0, total - used);
            dom.dbStatsUsed.textContent = `${Math.round(used)} KB`;
            dom.dbStatsTotal.textContent = `~${total.toLocaleString('en-US')} KB`;
            dom.dbStatsFree.textContent = `~${Math.round(free).toLocaleString('en-US')} KB`;
            dom.dbStatsCount.textContent = count;
            const percent = Math.min(100, used / total * 100);
            dom.dbStatsBarUsed.style.width = percent + "%";
            dom.dbStatsBarUsed.style.background = percent < 80
                ? 'linear-gradient(90deg, #6366f1, #3b82f6, #60a5fa)'
                : 'linear-gradient(90deg, #fb7185, #fbbf24)';
        }

        // --- UI rendering and logic ---
        function renderPhotos() {
            dom.photosGrid.innerHTML = '';
            if (state.photos.length === 0) {
                dom.emptyGallery.style.display = 'flex';
                return;
            }
            dom.emptyGallery.style.display = 'none';
            state.photos.forEach((photo, index) => {
                dom.photosGrid.appendChild(createPhotoCard(photo, index));
            });
        }
        function updateCounter() {
            const count = state.photos.length;
            dom.photoCounter.textContent = `${count} photo${count !== 1 ? 's' : ''}`;
            dom.clearAllBtn.disabled = count === 0;
        }
        function createPhotoCard(photo, index) {
            const photoCard = document.createElement('div');
            photoCard.className = 'photo-card';
            photoCard.dataset.id = photo.id;
            photoCard.dataset.index = index;
            const cardStyle = {};
            const computedStyle = window.getComputedStyle(photoCard);
            for (let i = 0; i < computedStyle.length; i++) {
                const prop = computedStyle[i];
                cardStyle[prop] = computedStyle.getPropertyValue(prop);
            }
            state.originalStyles[photoCard.id] = cardStyle;
            photoCard.innerHTML = `
                <img src="${photo.url}" alt="${photo.name}" class="w-full" loading="lazy">
                <div class="p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-medium text-gray-500 truncate">${photo.name}</span>
                        <span class="text-xs text-gray-400">${Math.round(photo.size/1024)}KB</span>
                    </div>
                </div>
                <button class="delete-btn">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            `;
            photoCard.draggable = true;
            photoCard.addEventListener('dragstart', function(e) {
                state.draggedItem = this;
                state.draggedIndex = index;
                setTimeout(() => this.classList.add('dragging'), 0);
                const dragImg = document.createElement('img');
                dragImg.className = 'drag-image';
                dragImg.src = photo.url;
                dragImg.style.width = '250px';
                dragImg.style.height = '150px';
                const dragWrapper = document.createElement('div');
                dragWrapper.className = 'drag-wrapper';
                dragWrapper.appendChild(dragImg);
                e.dataTransfer.setDragImage(dragWrapper, 250, 150);
                e.dataTransfer.effectAllowed = 'move';
            });
            photoCard.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
                document.querySelectorAll('.photo-card:not(.dragging).not-dragover').forEach(card => {
                    Object.entries(state.originalStyles[card.id] || {}).forEach(([prop, value]) => {
                        card.style[prop] = value;
                    });
                });
            });
            photoCard.addEventListener('dragenter', function(e) {
                e.preventDefault();
                this.style.cssText = `
                    opacity: 0.95 !important;
                    transform: scale(1) !important;
                    z-index: 999 !important;
                    box-shadow: 0 6px 20px rgba(0,0,0,0.1) !important;
                `;
            });
            photoCard.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
                document.querySelectorAll('.photo-card').forEach(card => {
                    const cardStyle = state.originalStyles[card.id];
                    for (let prop in cardStyle) {
                        card.style[prop] = cardStyle[prop];
                    }
                });
            });
            photoCard.addEventListener('drop', async function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (state.draggedItem !== this) {
                    const draggedIndex = state.draggedIndex;
                    const targetIndex = parseInt(this.dataset.index);
                    if (state.draggedItem && draggedIndex !== targetIndex) {
                        const movedPhoto = state.photos[draggedIndex];
                        state.photos.splice(draggedIndex, 1);
                        state.photos.splice(targetIndex, 0, movedPhoto);
                        await savePhotoOrder();
                        renderPhotos();
                    }
                }
            });
            photoCard.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                document.querySelectorAll('.photo-card').forEach(el => {
                    el.classList.remove('drag-over');
                    const cardStyle = state.originalStyles[el.id];
                    for (let prop in cardStyle) {
                        el.style[prop] = cardStyle[prop];
                    }
                });
                state.draggedItem = null;
            });
            photoCard.querySelector('.delete-btn').addEventListener('click', async (e) => {
                e.stopPropagation();
                await deletePhoto(index, photo.id);
            });
            return photoCard;
        }
        async function savePhotoOrder() {
            for (let i = 0; i < state.photos.length; i++) {
                state.photos[i].order = i;
                await updatePhotoDB(state.photos[i]);
            }
            updateDbStatsPanel();
        }
        function compressImage(dataURL, maxSize = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = dataURL;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxSize || height > maxSize) {
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = width * ratio;
                        height = height * ratio;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const format = dataURL.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
                    try {
                        resolve({
                            dataUrl: canvas.toDataURL(format, quality),
                            width,
                            height
                        });
                    } catch (e) {
                        resolve({dataUrl: dataURL, width: img.width, height: img.height});
                    }
                };
                img.onerror = reject;
            });
        }
        async function deletePhoto(index, id) {
            state.photos.splice(index, 1);
            await deletePhotoFromDB(id);
            renderPhotos();
            updateCounter();
            updateDbStatsPanel();
        }
        // --- Loader and events ---
        function createFileStatusItem(file, index) {
            const extension = file.name.split('.').pop().toLowerCase();
            const icons = {
                jpg: 'fas fa-file-image text-yellow-500',
                jpeg: 'fas fa-file-image text-yellow-500',
                png: 'fas fa-file-image text-blue-500',
                webp: 'fas fa-file-image text-purple-500',
            };
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item bg-slate-50 rounded-xl p-4 flex items-start gap-3';
            fileItem.id = `file-${index}`;
            fileItem.innerHTML = `
                <div class="file-icon mt-1 text-lg ${icons[extension] || 'fas fa-file text-slate-400'}"></div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between">
                        <div class="file-name text-base text-slate-800 font-medium truncate">${file.name}</div>
                        <button class="remove-file px-2 text-slate-400 hover:text-red-500" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="file-status mt-1 text-sm text-slate-500" id="status-${index}">Waiting to process</div>
                    <div class="progress-container mt-2 bg-slate-200 rounded-full h-2">
                        <div class="progress-fill h-full rounded-full" id="progress-${index}" style="width: 0%"></div>
                    </div>
                </div>
                <div class="status-indicator ml-2" id="indicator-${index}">
                    <div class="status-loading w-[18px] h-[18px] border-2 border-gray-300 border-t-indigo-500 rounded-full animate-spin"></div>
                </div>
            `;
            return fileItem;
        }
        function updateFileStatus(index, status, progress = 0) {
            const statusElement = document.getElementById(`status-${index}`);
            const progressElement = document.getElementById(`progress-${index}`);
            const indicator = document.getElementById(`indicator-${index}`);
            if (statusElement) statusElement.textContent = status;
            if (progressElement) progressElement.style.width = `${progress}%`;
            if (status === 'Completed') {
                indicator.innerHTML = '<div class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center text-xs text-white"><i class="fas fa-check"></i></div>';
            } else if (status.includes('Error') || status.includes('Failed')) {
                indicator.innerHTML = '<div class="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-xs text-white"><i class="fas fa-exclamation"></i></div>';
            }
        }
     async function processFile(file, index) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        state.currentUpload.readers[index] = reader;
        reader.onload = (e) => {
            const imageDataUrl = e.target.result;
            const img = new Image();
            img.onload = function() {
                resolve({
                    url: imageDataUrl,
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    width: img.width,
                    height: img.height,
                    date: new Date().toISOString(),
                    order: state.photos.length
                });
            };
            img.onerror = function() {
                reject('Failed to load image');
            };
            img.src = imageDataUrl;
        };
        reader.onerror = () => reject('File reading error');
        reader.onabort = () => reject('Upload cancelled');
        reader.readAsDataURL(file);
    });
}
        async function addPhotos(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type.match(/image\/(jpeg|png|webp)/) && file.size < 5 * 1024 * 1024
            );
            if (validFiles.length === 0) {
                return alert('No valid images found. Supported formats: JPG, PNG, WebP (max 5MB)');
            }
            dom.topLoader.classList.add('active');
            dom.fileList.innerHTML = '';
            validFiles.forEach((file, index) => {
                state.currentUpload.fileItems[index] = createFileStatusItem(file, index);
                dom.fileList.appendChild(state.currentUpload.fileItems[index]);
                updateFileStatus(index, 'Waiting to upload', 0);
            });
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.index);
                    const item = document.getElementById(`file-${idx}`);
                    if (item) item.style.opacity = '0.3';
                    if (state.currentUpload.readers[idx]) {
                        state.currentUpload.readers[idx].abort();
                    }
                    updateFileStatus(idx, 'Removed', 0);
                    setTimeout(() => {
                        if (item) item.remove();
                    }, 300);
                });
            });
            const uploadPromises = validFiles.map((file, index) => 
                processFile(file, index)
                    .then(async photo => {
                        const photoId = await savePhotoToDB(photo);
                        if (photoId) {
                            state.photos.push({...photo, id: photoId});
                            updateFileStatus(index, 'Completed', 100);
                        }
                        return photo;
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        updateFileStatus(index, error, 0);
                        return null;
                    })
            );
            await Promise.all(uploadPromises);
            renderPhotos();
            updateCounter();
            updateDbStatsPanel();
            setTimeout(() => {
                dom.topLoader.classList.remove('active');
            }, 2000);
        }
        function setupEventListeners() {
            dom.selectFilesBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('input', (e) => {
                if (e.target.files.length > 0) {
                    addPhotos(e.target.files);
                    e.target.value = '';
                }
            });
            dom.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dom.uploadArea.classList.add('active');
            });
            dom.uploadArea.addEventListener('dragleave', () => {
                dom.uploadArea.classList.remove('active');
            });
            dom.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dom.uploadArea.classList.remove('active');
                if (e.dataTransfer.files.length > 0) {
                    addPhotos(e.dataTransfer.files);
                }
            });
            dom.clearAllBtn.addEventListener('click', clearAllPhotos);
            dom.cancelAllBtn.addEventListener('click', () => {
                dom.topLoader.classList.remove('active');
                Object.values(state.currentUpload.readers).forEach(reader => {
                    if (reader && typeof reader.abort === 'function') {
                        reader.abort();
                    }
                });
                state.currentUpload = { files: [], readers: {}, fileItems: {} };
            });
            dom.loaderClose.addEventListener('click', () => {
                dom.topLoader.classList.remove('active');
            });
        }
    </script>
</body>
</html>